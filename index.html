<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Matty's 890 Tweaks • Live Sync</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect width='100%25' height='100%25' fill='%23ff6a00'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='54' fill='white'%3E890%3C/text%3E%3C/svg%3E">
<style>
  :root { --bg:#0f1115; --panel:#161a20; --muted:#8a93a6; --text:#e9edf3; --brand:#ff6a00; --ok:#20c997; --warn:#ffd43b; --err:#ff6b6b; --chip:#202633; --card:#121620; --border:#232938; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:linear-gradient(120deg,#0d1016,#121823 60%,#0d1016);min-height:100vh}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(150%) blur(8px);background:rgba(15,17,21,.6);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px 16px}
  .title{display:flex;align-items:center;gap:12px}
  .logo{width:36px;height:36px;background:conic-gradient(from 180deg,#ff6a00,#ff9a3c);border-radius:10px;display:grid;place-items:center;font-weight:800;color:#111}
  h1{font-size:20px;margin:0}
  .status{margin-left:auto;display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;flex-wrap:wrap}
  .status-dot{width:8px;height:8px;border-radius:50%}
  .ok{background:var(--ok)} .sync{background:var(--warn)} .err{background:var(--err)}
  #errTip{color:#ffd43b}
  #lastSync{opacity:.85}
  #settingsBtn{margin-left:8px}

  main .wrap{display:grid;grid-template-columns:360px 1fr;gap:18px;padding-top:20px;align-items:start}
  @media (max-width:980px){ main .wrap{grid-template-columns:1fr} }
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
  .panel h2{margin:4px 0 12px;font-size:14px;color:#cfd6e6;letter-spacing:.3px}

  .btn,button{background:linear-gradient(180deg,#222a39,#1a202e);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;letter-spacing:.2px;transition:.12s}
  .btn:hover{border-color:#344055;transform:translateY(-1px)}
  .btn.ghost{background:transparent}
  .btn.brand{background:linear-gradient(180deg,#ff7a1d,#ff6a00);color:#111;border:none}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* BIKE LIST */
  .bikes{display:flex;flex-direction:column;gap:8px}
  .bike-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;cursor:pointer;transition:.15s}
  .bike-item:hover{transform:translateY(-1px);border-color:#2b3244}
  .bike-item.active{outline:2px solid var(--brand);box-shadow:0 0 0 4px #ff6a001a}
  .bike-photo{width:42px;height:42px;border-radius:50%;border:1px solid var(--border);object-fit:cover;background:#111}
  .bike-title{font-weight:700}
  .bike-sub{color:#9aa3b5;font-size:12px}
  .bike-actions{margin-left:auto;display:flex;gap:6px}

  /* SCENARIOS */
  .scenarios{display:flex;flex-direction:column;gap:8px}
  .scenario-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;cursor:pointer;transition:.15s}
  .scenario-item:hover{transform:translateY(-1px);border-color:#2b3244}
  .scenario-item.active{outline:2px solid var(--brand);box-shadow:0 0 0 4px #ff6a001a}
  .scenario-title{font-weight:600}
  .scenario-actions{margin-left:auto;display:flex;gap:6px}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media (max-width:780px){ .grid{grid-template-columns:1fr} }

  .setting{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
  .setting h4{margin:0 0 8px;font-size:13px;color:#cfd6e6;letter-spacing:.3px;display:flex;justify-content:space-between;gap:8px}
  .suffix{font-weight:700;color:#a6ffd1;font-size:12px;min-width:120px;text-align:right}
  .ctrl{display:grid;grid-template-columns:76px 1fr 76px;gap:10px;align-items:center}
  .ctrl button{height:64px;border-radius:12px;font-size:32px;display:grid;place-items:center;background:linear-gradient(180deg,#1e2431,#171c27);border:1px solid var(--border)}
  .ctrl button:active{transform:scale(.98)}
  .value{border:1px solid var(--border);height:64px;border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:18px;letter-spacing:.5px;background:#222;transition:background-color .15s linear}
  .value small{display:block;font-weight:600;color:#d1d7e6;opacity:.9;margin-top:2px;font-size:11px}

  textarea{width:100%;min-height:110px;resize:vertical;padding:10px;border-radius:12px;outline:none;background:var(--card);color:var(--text);border:1px solid var(--border)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:#cfd6e6}
  .hr{height:1px;background:var(--border);margin:12px 0}
  .badge{font-size:11px;color:#7bd890;border:1px solid #2e3a2e;background:#163016;padding:2px 6px;border-radius:999px}

  /* PRESETS (vertical) */
  .presets-vertical{display:flex;flex-direction:column;gap:10px;max-height:360px;overflow:auto}
  .preset{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
  .preset strong{display:block;margin-bottom:6px}

  /* Lock visuals (bottom-right) */
  .lock-area{display:flex;justify-content:flex-end;margin-top:12px}
  .lock-btn{font-weight:700}
  .locked .ctrl button{opacity:.4;pointer-events:none}
  .locked .value{filter:grayscale(.4) brightness(.9)}
  .locked textarea{opacity:.6;pointer-events:none}
  .locked .lock-btn{color:#ffb7b7}
  .unlocked .lock-btn{opacity:.6}
</style>
<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
</head>
<body>
<header>
  <div class="wrap title">
    <div class="logo">M</div>
    <h1>Matty's 890 Tweaks</h1>

    <div class="status" style="margin-left:auto">
      <span class="status-dot ok" id="syncDot"></span>
      <span id="syncText">Loading…</span>
      <span id="lastSync"></span>
      <span id="errTip" style="display:none"></span>
      <button class="btn" id="settingsBtn">Settings</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <!-- LEFT: Bikes + Scenarios + Presets -->
    <aside class="panel">
      <h2>Bikes</h2>
      <div class="toolbar" style="margin-bottom:10px">
        <button class="btn brand" id="addBikeBtn">+ Add Bike</button>
        <button class="btn ghost" id="editBikeBtn">Edit</button>
        <button class="btn ghost" id="deleteBikeBtn">Delete</button>
      </div>
      <div id="bikeList" class="bikes"></div>

      <div class="hr"></div>
      <h2>Scenarios</h2>
      <div class="toolbar" style="margin-bottom:10px">
        <button class="btn brand" id="addScenarioBtn">+ New Scenario</button>
        <button class="btn ghost" id="renameScenarioBtn">Rename</button>
        <button class="btn ghost" id="deleteScenarioBtn">Delete</button>
      </div>
      <div id="scenarioList" class="scenarios"></div>

      <div class="hr"></div>
      <h2>Presets</h2>
      <div id="presetColumn" class="presets-vertical"></div>
    </aside>

    <!-- RIGHT: Detail -->
    <section class="panel" id="detailPanel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 id="currentTitle" style="margin:0">—</h2>
        <div class="row">
          <label class="pill">Reset to</label>
          <select id="quickPreset" class="btn" style="min-width:160px">
            <option value="">— choose preset —</option>
            <option>Comfort</option>
            <option>Standard</option>
            <option>Sport</option>
            <option>Loaded</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <!-- FRONT -->
        <div class="card">
          <h3 style="margin:0 0 10px 0">Front</h3>

          <div class="setting" data-setting="front.preload">
            <h4>PRELOAD <span class="suffix" id="suffix-front.preload"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.preload">−</button>
              <div class="value" id="front.preload">0<small>T-Grip CW</small></div>
              <button data-delta="1" data-path="front.preload">+</button>
            </div>
          </div>

          <div class="setting" data-setting="front.comp">
            <h4>COMP <span class="suffix" id="suffix-front.comp"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.comp">−</button>
              <div class="value" id="front.comp">0<small>clicks CCW</small></div>
              <button data-delta="1" data-path="front.comp">+</button>
            </div>
          </div>

          <div class="setting" data-setting="front.reb">
            <h4>REB <span class="suffix" id="suffix-front.reb"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.reb">−</button>
              <div class="value" id="front.reb">0<small>clicks CCW</small></div>
              <button data-delta="1" data-path="front.reb">+</button>
            </div>
          </div>
        </div>

        <!-- REAR -->
        <div class="card">
          <h3 style="margin:0 0 10px 0">Rear</h3>

          <div class="setting" data-setting="rear.preload">
            <h4>PRELOAD <span class="suffix" id="suffix-rear.preload"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.preload">−</button>
              <div class="value" id="rear.preload">0<small>turns CW</small></div>
              <button data-delta="1" data-path="rear.preload">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.lsc">
            <h4>LS COMP <span class="suffix" id="suffix-rear.lsc"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.lsc">−</button>
              <div class="value" id="rear.lsc">0<small>clicks CCW</small></div>
              <button data-delta="1" data-path="rear.lsc">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.hsc">
            <h4>HS COMP <span class="suffix" id="suffix-rear.hsc"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.hsc">−</button>
              <div class="value" id="rear.hsc">0<small>turns CCW</small></div>
              <button data-delta="1" data-path="rear.hsc">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.reb">
            <h4>REB <span class="suffix" id="suffix-rear.reb"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.reb">−</button>
              <div class="value" id="rear.reb">0<small>clicks CCW</small></div>
              <button data-delta="1" data-path="rear.reb">+</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 10px 6px">Notes</h3>
        <textarea id="notes" placeholder="Ride impressions, terrain, tyres, clicker changes..."></textarea>
      </div>

      <div class="lock-area">
        <button class="btn lock-btn" id="toggleLockBtn">lock</button>
      </div>
    </section>
  </div>
</main>

<!-- Settings dialog -->
<dialog id="settingsDlg" style="border:none;border-radius:16px;padding:0;max-width:620px;width:95%">
  <div class="panel" style="border-radius:16px">
    <h2>Settings</h2>
    <div class="row">
      <label class="pill">Dropbox file path</label>
      <input id="dbxPath" class="btn" style="flex:1;text-align:left" />
    </div>
    <div class="row" style="margin-top:10px">
      <label class="pill">Access token</label>
      <input id="dbxToken" class="btn" style="flex:1;text-align:left" placeholder="Paste your Dropbox token" />
    </div>
    <div class="hr"></div>
    <div class="row">
      <label class="pill">Sign into Dropbox</label>
      <button class="btn brand" id="oauthBtn" disabled title="Coming in Step 3">Sign in</button>
    </div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn ghost" id="closeSettings">Close</button>
      <button class="btn brand" id="saveSettings">Save</button>
    </div>
  </div>
</dialog>

<!-- Add/Edit Bike dialog -->
<dialog id="bikeDlg" style="border:none;border-radius:16px;padding:0;max-width:620px;width:95%">
  <div class="panel" style="border-radius:16px">
    <h2 id="bikeDlgTitle">Add Bike</h2>
    <div class="row" style="gap:12px">
      <input id="bikeYear" class="btn" placeholder="Year" style="flex:1;text-align:left">
      <input id="bikeMake" class="btn" placeholder="Make" style="flex:1;text-align:left">
      <input id="bikeModel" class="btn" placeholder="Model" style="flex:1;text-align:left">
    </div>
    <div class="row" style="gap:12px; margin-top:10px">
      <input id="bikeRego" class="btn" placeholder="Rego" style="flex:1;text-align:left">
      <input id="bikePhotoUrl" class="btn" placeholder="Photo URL (optional)" style="flex:2;text-align:left">
    </div>
    <div class="row" style="gap:12px; margin-top:10px">
      <input type="file" id="bikePhotoFile" accept="image/*" class="btn" style="flex:1">
      <span class="pill">You can paste a URL or pick a photo (resized).</span>
    </div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn ghost" id="cancelBike">Cancel</button>
      <button class="btn brand" id="saveBike">Save Bike</button>
    </div>
  </div>
</dialog>

<footer class="wrap" style="color:#8a93a6;font-size:12px; padding-bottom:24px">
  Next: Service Records + Dropbox file upload for receipts + Tuning Tips page.
</footer>

<script>
/* ===================== CONSTANTS & DEFAULTS ===================== */
const LOCAL_KEY = 'matty890.v6.multibike';
const TOKEN_KEY = 'matty890.dbx.token';
const PATH_KEY  = 'matty890.dbx.path';
const DEFAULT_DBX_PATH = '/suspension.json'; // App-Folder friendly

/* Ranges & labels */
const RANGES = {
  'front.preload': { unit:'+',     values:[0,1,2,3],                                  labels:{0:'Comfort',3:'Loaded'},                 softIncreasing:false },
  'front.comp':    { unit:'clicks',values:[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5], labels:{20:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  },
  'front.reb':     { unit:'clicks',values:[22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5],     labels:{18:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  },
  'rear.preload':  { unit:'turns', values:[1,2,3,4,5,6,7,8,9,10,11,12],              labels:{4:'Comf/Std/Sport',10:'Loaded'},         softIncreasing:false },
  'rear.lsc':      { unit:'clicks',values:[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4], labels:{20:'Comfort',15:'Standard',10:'Sport',7:'Full Payload'}, softIncreasing:true },
  'rear.hsc':      { unit:'turns', values:[2,1.5,1,0.5],                              labels:{2:'Comfort',1.5:'Standard',1:'Sport',0.5:'Loaded'}, softIncreasing:true },
  'rear.reb':      { unit:'clicks',values:[22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5],     labels:{18:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  }
};

const DEFAULT_SCENARIOS = {
  'Comfort':  { front:{preload:0, comp:20, reb:18}, rear:{preload:4, lsc:20, hsc:2,   reb:18}, notes:'Comfort baseline', locked:false },
  'Standard': { front:{preload:1, comp:15, reb:15}, rear:{preload:4, lsc:15, hsc:1.5, reb:15}, notes:'Standard baseline', locked:false },
  'Sport':    { front:{preload:1, comp:10, reb:10}, rear:{preload:4, lsc:10, hsc:1,   reb:10}, notes:'Sport baseline',   locked:false },
  'Loaded':   { front:{preload:3, comp:15, reb:15}, rear:{preload:10,lsc:7,  hsc:0.5, reb:15}, notes:'Loaded baseline',  locked:false }
};

function newBike(name='New Bike'){
  return {
    info: { year:'', make:'', model:name, rego:'', photo:'' },
    currentScenario: 'Standard',
    scenarios: {
      'High Speed Naked': { front:{preload:0, comp:15, reb:15}, rear:{preload:4, lsc:15, hsc:1.5, reb:15}, notes:'', locked:false },
      'Loaded Touring':   { front:{preload:3, comp:15, reb:15}, rear:{preload:10,lsc:7,  hsc:0.5, reb:15}, notes:'', locked:false },
      'Enduro / Singles': { front:{preload:1, comp:18, reb:16}, rear:{preload:5, lsc:18, hsc:1.5, reb:16}, notes:'', locked:false }
    },
    service: [] // Step 2
  };
}

let data = {
  currentBikeId: '',
  bikes: {},
  updatedAt: new Date().toISOString()
};

/* ===================== UTILITIES ===================== */
const $ = (id)=>document.getElementById(id);
const byQS = (sel,root=document)=>root.querySelector(sel);
function setStatus(state,text){
  $('syncDot').className='status-dot '+(state==='ok'?'ok':state==='sync'?'sync':'err');
  $('syncText').textContent=text;
}
function setLastSync(){
  $('lastSync').textContent = '· Last sync: ' + new Date().toLocaleTimeString();
}
function uid(){ return 'b'+Math.random().toString(36).slice(2,9)+Date.now().toString(36); }

/* ----- Color helpers ----- */
function valuesFor(path){ return RANGES[path].values; }
function labelsFor(path){ return RANGES[path].labels || {}; }
function unitFor(path){ return RANGES[path].unit || ''; }
function idxOf(path,val){ return valuesFor(path).findIndex(v=>v===val); }
function nextVal(path,val,delta){ const arr=valuesFor(path); let i=idxOf(path,val); if(i===-1)i=0; i=Math.min(arr.length-1,Math.max(0,i+(delta>0?1:-1))); return arr[i]; }
function labelFor(path,val){ const lbls=labelsFor(path); return (val in lbls)?lbls[val]:''; }
// 0=hard/firm/slow(red) .. 1=soft/fast/quick(green)
function softness(path,val){
  const arr=valuesFor(path); const n=arr.length-1||1;
  let idx=arr.findIndex(v=>v===val); if(idx<0) idx=0;
  const ascending = arr[0] <= arr[arr.length-1];
  const posFromLow = ascending ? (idx/n) : (1-idx/n);
  return RANGES[path].softIncreasing ? posFromLow : (1-posFromLow);
}
function colorFor(path,val){ const s=softness(path,val); const hue=0+120*s; return `hsl(${hue.toFixed(0)} 70% 32%)`; }
function displayText(path,val){
  const u=unitFor(path);
  if(u==='turns') return `${val} ${val===1?'turn':'turns'}`;
  if(u==='+') return `${val} +`;
  if(u==='clicks') return `${val} click${val===1?'':'s'}`;
  return `${val} ${u}`.trim();
}

/* ===================== STORAGE & DROPBOX ===================== */
function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LOCAL_KEY)); }catch{ return null; } }
function saveLocal(){ data.updatedAt=new Date().toISOString(); localStorage.setItem(LOCAL_KEY, JSON.stringify(data)); }

let dbx = null;
async function ensureDropbox(){
  const token = (localStorage.getItem(TOKEN_KEY)||'').trim();
  if(!token) return null;
  if(!dbx) dbx = new Dropbox.Dropbox({ accessToken: token });
  return dbx;
}
function explainDropboxError(e){
  try{
    const status = e && (e.status || e.statusCode) ? `HTTP ${e.status || e.statusCode} ` : '';
    if(e && e.error) return status + (typeof e.error==='string'? e.error : (e.error.error_summary || JSON.stringify(e.error)));
    return status + (e && e.message || 'Unknown error');
  }catch{ return 'Unknown error'; }
}
function withTimeout(promise, ms, label='operation'){
  return Promise.race([
    promise,
    new Promise((_,rej)=>setTimeout(()=>rej(new Error(label+' timeout')), ms))
  ]);
}
function blobFromDropboxDownload(resp){
  if (!resp) return null;
  if (resp.fileBlob instanceof Blob) return resp.fileBlob;
  if (resp.result && resp.result.fileBlob instanceof Blob) return resp.result.fileBlob;
  if (resp.fileBinary) return new Blob([resp.fileBinary]);
  if (resp.result && resp.result.fileBinary) return new Blob([resp.result.fileBinary]);
  if (resp.blob instanceof Blob) return resp.blob;
  if (resp.result instanceof Blob) return resp.result;
  if (resp instanceof Blob) return resp;
  return null;
}

async function loadFromDropboxFirst(){
  const token = (localStorage.getItem(TOKEN_KEY)||'').trim();
  const path  = (localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH).trim() || '/suspension.json';

  const fallbackLocal=()=>{
    const local = loadLocal();
    if(local){ data=local; migrateIfNeeded(); }
    else { // first-run defaults
      const id = uid(); data = { currentBikeId:id, bikes:{ [id]: newBike('890 Adventure') }, updatedAt:new Date().toISOString() };
    }
  };

  if(!token){
    fallbackLocal();
    setStatus('err','No Dropbox token — using local data');
    $('errTip').style.display='inline'; $('errTip').textContent='Open Settings and paste your Dropbox token; path: /suspension.json';
    return;
  }

  try{
    const cli = await ensureDropbox();
    const resp = await withTimeout(cli.filesDownload({ path }), 6000, 'Dropbox load');
    const blob = blobFromDropboxDownload(resp);
    if (!blob) throw new Error('No file blob returned from Dropbox');
    const text = await blob.text();
    const cloud = JSON.parse(text);
    if(cloud){
      data = cloud; migrateIfNeeded(); saveLocal();
      setStatus('ok','Loaded from Dropbox'); $('errTip').style.display='none'; setLastSync(); return;
    }
    fallbackLocal(); setStatus('err','Dropbox file invalid — using local data');
  }catch(e){
    console.warn('Dropbox load failed:', e);
    fallbackLocal();
    setStatus('err','Dropbox load failed — using local data');
    $('errTip').style.display='inline'; $('errTip').textContent = explainDropboxError(e);
  }
}

async function syncToDropbox(){
  try{
    const cli = await ensureDropbox();
    if(!cli){ setStatus('ok','Saved locally'); return; }
    const path = (localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH).trim() || '/suspension.json';
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    await withTimeout(cli.filesUpload({ path, contents: blob, mode:{'.tag':'overwrite'}, mute:true }), 6000, 'Dropbox save');
    setStatus('ok','All changes saved'); setLastSync();
  }catch(e){
    console.error('Dropbox upload failed:', e);
    setStatus('err','Dropbox error (saved locally)');
    $('errTip').style.display='inline'; $('errTip').textContent = explainDropboxError(e);
  }
}
let syncTimer=null;
function debounceSync(){ clearTimeout(syncTimer); syncTimer=setTimeout(syncToDropbox,600); setStatus('sync','Syncing…'); }

/* ===================== MIGRATION (old single-bike JSON -> multi-bike) ===================== */
function migrateIfNeeded(){
  if(data && data.scenarios && !data.bikes){
    const id = uid();
    const bike = newBike('Imported Bike');
    bike.scenarios = JSON.parse(JSON.stringify(data.scenarios));
    bike.currentScenario = data.current || Object.keys(bike.scenarios)[0] || 'Standard';
    data = { currentBikeId:id, bikes:{ [id]: bike }, updatedAt:new Date().toISOString() };
  }
  if(!data.currentBikeId || !data.bikes || !Object.keys(data.bikes).length){
    const id = uid(); data.currentBikeId = id; data.bikes = { [id]: newBike('My Bike') };
  }
}

/* ===================== BIKE HELPERS ===================== */
function curBike(){ return data.bikes[data.currentBikeId]; }
function bikeTitle(b){
  const i=b.info||{}; const parts=[i.year,i.make,i.model].filter(Boolean).join(' ');
  return parts || 'Untitled Bike';
}

/* ===================== RENDER ===================== */
function renderBikeList(){
  const list = $('bikeList'); list.innerHTML='';
  Object.entries(data.bikes).forEach(([id,b])=>{
    const item=document.createElement('div'); item.className='bike-item'+(id===data.currentBikeId?' active':'');
    const photo = b.info.photo ? `<img class="bike-photo" src="${b.info.photo}" alt="">` : `<div class="bike-photo"></div>`;
    item.innerHTML = `
      ${photo}
      <div>
        <div class="bike-title">${bikeTitle(b)}</div>
        <div class="bike-sub">${b.info.rego ? b.info.rego+' · ' : ''}${Object.keys(b.scenarios).length} scenarios</div>
      </div>
      <div class="bike-actions"></div>`;
    item.onclick = ()=>{ data.currentBikeId=id; saveLocal(); renderAll(); debounceSync(); };
    list.appendChild(item);
  });
}

function summaryChip(s){
  return `F: ${s.front.preload}/${s.front.comp}/${s.front.reb} | R: ${s.rear.preload}/${s.rear.lsc}/${s.rear.hsc}/${s.rear.reb}`;
}

function renderScenarioList(){
  const list=$('scenarioList'); list.innerHTML='';
  const b=curBike();
  Object.keys(b.scenarios).forEach(name=>{
    const s=b.scenarios[name];
    const item=document.createElement('div'); item.className='scenario-item'+(b.currentScenario===name?' active':'');
    item.innerHTML=`<div class="scenario-title">${name}${s.locked?' <span class="badge">LOCK</span>':''}</div>
                    <div class="scenario-actions"><span class="pill">${summaryChip(s)}</span></div>`;
    item.onclick=()=>{ b.currentScenario=name; saveLocal(); renderAll(); debounceSync(); };
    list.appendChild(item);
  });
}

function renderPresets(){
  const col=$('presetColumn'); col.innerHTML='';
  Object.entries(DEFAULT_SCENARIOS).forEach(([name,sc])=>{
    const card = document.createElement('div'); card.className='preset';
    card.innerHTML = `<strong>${name}</strong><div style="color:#9aa3b5;font-size:12px;margin-bottom:8px">${summaryChip(sc)}</div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" data-act="apply" data-name="${name}">Apply to current</button>
        <button class="btn brand" data-act="saveas" data-name="${name}">Save as new</button>
      </div>`;
    col.appendChild(card);
  });
  col.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const act=btn.dataset.act, name=btn.dataset.name;
      if(isLocked()) return alert('Unlock this scenario to use presets.');
      if(act==='apply') applyPreset(name);
      if(act==='saveas') savePresetAs(name);
    });
  });
}

function updateOne(path){
  const v=get(path); const el=$(path); const suf=$('suffix-'+path);
  el.textContent=displayText(path,v);
  el.style.background=colorFor(path,v);
  suf.textContent=labelFor(path,v);
  renderScenarioList();
}

function renderValues(){
  Object.keys(RANGES).forEach(updateOne);
  $('currentTitle').textContent=curBike().currentScenario;
  $('notes').value=cur().notes||'';
  applyLockedUI();
}

function renderAll(){ renderBikeList(); renderScenarioList(); renderPresets(); renderValues(); }

/* ===================== GET/SET ===================== */
function get(path){ const [g,k]=path.split('.'); return cur()[g][k]; }
function set(path,value){ const [g,k]=path.split('.'); cur()[g][k]=value; saveLocal(); updateOne(path); debounceSync(); }
function cur(){ const b=curBike(); return b.scenarios[b.currentScenario]; }
function isLocked(){ return !!cur().locked; }
function applyLockedUI(){
  const locked=isLocked();
  const panel=$('detailPanel');
  panel.classList.toggle('locked',locked);
  panel.classList.toggle('unlocked',!locked);
  const btn=$('toggleLockBtn');
  btn.textContent = locked ? 'LOCK' : 'lock';
  btn.classList.toggle('brand', locked);
}

/* ===================== PRESETS ===================== */
function applyPreset(name){
  const p=DEFAULT_SCENARIOS[name]; if(!p) return;
  const c=cur();
  c.front={...p.front}; c.rear={...p.rear};
  saveLocal(); renderValues(); debounceSync();
}
function savePresetAs(name){
  const b=curBike();
  const newName = prompt(`Save "${name}" as:`, name+' Copy'); if(!newName) return;
  if(b.scenarios[newName]) return alert('That name already exists.');
  b.scenarios[newName] = JSON.parse(JSON.stringify(DEFAULT_SCENARIOS[name]));
  b.currentScenario = newName;
  saveLocal(); renderAll(); debounceSync();
}

/* ===================== EVENTS ===================== */
document.addEventListener('click', e=>{
  const btn=e.target.closest('button[data-path]'); if(!btn) return;
  if(isLocked()) return;
  const path=btn.dataset.path, delta=parseInt(btn.dataset.delta,10);
  set(path, nextVal(path, get(path), delta));
});

$('notes').addEventListener('input', ()=>{
  if(isLocked()) return;
  cur().notes = $('notes').value;
  saveLocal(); debounceSync();
});

$('quickPreset').addEventListener('change', ()=>{
  const v=$('quickPreset').value; if(!v) return;
  if(isLocked()) return alert('Unlock this scenario first.');
  applyPreset(v);
  $('quickPreset').value='';
});

/* Scenarios CRUD */
$('addScenarioBtn').onclick=()=>{
  if(isLocked()) return alert('Unlock to add a scenario.');
  const name=prompt('New scenario name:','Custom Setup'); if(!name) return;
  const b=curBike(); if(b.scenarios[name]) return alert('That name already exists.');
  b.scenarios[name]={ front:{preload:0,comp:20,reb:18}, rear:{preload:4,lsc:20,hsc:2,reb:18}, notes:'', locked:false };
  b.currentScenario=name; saveLocal(); renderAll(); debounceSync();
};
$('renameScenarioBtn').onclick=()=>{
  if(isLocked()) return alert('Unlock to rename.');
  const b=curBike();
  const newName=prompt('Rename scenario:', b.currentScenario); if(!newName || newName===b.currentScenario) return;
  if(b.scenarios[newName]) return alert('Name already exists.');
  b.scenarios[newName]=b.scenarios[b.currentScenario]; delete b.scenarios[b.currentScenario];
  b.currentScenario=newName; saveLocal(); renderAll(); debounceSync();
};
$('deleteScenarioBtn').onclick=()=>{
  if(isLocked()) return alert('Unlock to delete.');
  const b=curBike();
  if(!confirm(`Delete "${b.currentScenario}"?`)) return;
  const names=Object.keys(b.scenarios).filter(n=>n!==b.currentScenario);
  delete b.scenarios[b.currentScenario];
  b.currentScenario = names[0] || Object.keys(DEFAULT_SCENARIOS)[0];
  if(!b.scenarios[b.currentScenario]) b.scenarios[b.currentScenario]=JSON.parse(JSON.stringify(DEFAULT_SCENARIOS['Standard']));
  saveLocal(); renderAll(); debounceSync();
};

/* Lock button (bottom-right) */
$('toggleLockBtn').onclick=()=>{
  const c=cur();
  if(!c.locked) c.locked=true; else { if(!confirm('Unlock this scenario to allow changes?')) return; c.locked=false; }
  saveLocal(); applyLockedUI(); renderScenarioList(); debounceSync();
};

/* Bikes CRUD */
$('addBikeBtn').onclick=()=>openBikeDialog();
$('editBikeBtn').onclick=()=>{
  const b=curBike(); openBikeDialog(b, data.currentBikeId);
};
$('deleteBikeBtn').onclick=()=>{
  if(Object.keys(data.bikes).length<=1) return alert('You must have at least one bike.');
  const b=curBike();
  if(!confirm(`Delete bike "${bikeTitle(b)}"?`)) return;
  const ids = Object.keys(data.bikes).filter(id=>id!==data.currentBikeId);
  delete data.bikes[data.currentBikeId];
  data.currentBikeId = ids[0];
  saveLocal(); renderAll(); debounceSync();
};

/* Settings dialog */
$('settingsBtn').onclick=()=>{
  $('dbxToken').value=localStorage.getItem(TOKEN_KEY)||'';
  $('dbxPath').value=localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH;
  $('settingsDlg').showModal();
};
$('closeSettings').onclick=()=>$('settingsDlg').close();
$('saveSettings').onclick=()=>{
  localStorage.setItem(TOKEN_KEY, ($('dbxToken').value||'').trim());
  localStorage.setItem(PATH_KEY,  ($('dbxPath').value||'').trim()||DEFAULT_DBX_PATH);
  dbx=null;
  $('settingsDlg').close();
  loadFromDropboxFirst().then(()=>renderAll());
};

/* ===================== BIKE DIALOG + PHOTO ===================== */
function openBikeDialog(existing=null, id=null){
  $('bikeDlgTitle').textContent = existing ? 'Edit Bike' : 'Add Bike';
  $('bikeYear').value = existing?.info?.year || '';
  $('bikeMake').value = existing?.info?.make || '';
  $('bikeModel').value = existing?.info?.model || '';
  $('bikeRego').value = existing?.info?.rego || '';
  $('bikePhotoUrl').value = existing?.info?.photo || '';
  $('bikePhotoFile').value = '';
  $('bikeDlg').showModal();

  $('cancelBike').onclick=()=>$('bikeDlg').close();
  $('saveBike').onclick=async ()=>{
    const info = {
      year: $('bikeYear').value.trim(),
      make: $('bikeMake').value.trim(),
      model: $('bikeModel').value.trim(),
      rego: $('bikeRego').value.trim(),
      photo: $('bikePhotoUrl').value.trim()
    };
    const file = $('bikePhotoFile').files[0];
    if(file){
      try{ info.photo = await fileToDataUrlResized(file, 800); }catch{}
    }

    if(existing && id){
      existing.info = info;
    }else{
      const nid = uid();
      data.bikes[nid] = newBike(info.model||'New Bike');
      data.bikes[nid].info = info;
      data.currentBikeId = nid;
    }
    saveLocal(); $('bikeDlg').close(); renderAll(); debounceSync();
  };
}

function fileToDataUrlResized(file, maxW=800){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    const fr=new FileReader();
    fr.onload=()=>{ img.onload=()=>{
      const scale = Math.min(1, maxW/img.width);
      const w = Math.round(img.width*scale), h=Math.round(img.height*scale);
      const cv=document.createElement('canvas'); cv.width=w; cv.height=h;
      const cx=cv.getContext('2d'); cx.drawImage(img,0,0,w,h);
      resolve(cv.toDataURL('image/jpeg',0.8));
    }; img.onerror=reject; img.src=fr.result; };
    fr.onerror=reject; fr.readAsDataURL(file);
  });
}

/* ===================== INIT ===================== */
(async function init(){
  await loadFromDropboxFirst();
  renderAll();
})();
</script>
</body>
</html>
