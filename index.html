<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Matty's 890 Tweaks • Live Sync</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect width='100%25' height='100%25' fill='%23ff6a00'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='54' fill='white'%3E890%3C/text%3E%3C/svg%3E">

<style>
  :root { --bg:#0f1115; --panel:#161a20; --muted:#8a93a6; --text:#e9edf3; --brand:#ff6a00; --ok:#20c997; --warn:#ffd43b; --err:#ff6b6b; --chip:#202633; --card:#121620; --border:#232938; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:linear-gradient(120deg,#0d1016,#121823 60%,#0d1016);min-height:100vh}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(150%) blur(8px);background:rgba(15,17,21,.6);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px 16px}
  .title{display:flex;align-items:center;gap:12px}
  .logo{width:36px;height:36px;background:conic-gradient(from 180deg,#ff6a00,#ff9a3c);border-radius:10px;display:grid;place-items:center;font-weight:800;color:#111}
  h1{font-size:20px;margin:0}
  .status{margin-left:auto;display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
  .status-dot{width:8px;height:8px;border-radius:50%}
  .ok{background:var(--ok)} .sync{background:var(--warn)} .err{background:var(--err)}
  #errTip{color:#ffd43b}

  main .wrap{display:grid;grid-template-columns:320px 1fr;gap:18px;padding-top:20px;align-items:start}
  @media (max-width:980px){ main .wrap{grid-template-columns:1fr} }
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
  .panel h2{margin:4px 0 12px;font-size:14px;color:#cfd6e6;letter-spacing:.3px}

  .scenarios{display:flex;flex-direction:column;gap:8px}
  .scenario-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;cursor:pointer;transition:.15s}
  .scenario-item:hover{transform:translateY(-1px);border-color:#2b3244}
  .scenario-item.active{outline:2px solid var(--brand);box-shadow:0 0 0 4px #ff6a001a}
  .scenario-title{font-weight:600}
  .scenario-actions{margin-left:auto;display:flex;gap:6px}
  .padlock{margin-left:6px;font-size:12px;color:#ffb7b7}

  .btn,button{background:linear-gradient(180deg,#222a39,#1a202e);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;letter-spacing:.2px;transition:.12s}
  .btn:hover{border-color:#344055;transform:translateY(-1px)}
  .btn.ghost{background:transparent}
  .btn.brand{background:linear-gradient(180deg,#ff7a1d,#ff6a00);color:#111;border:none}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media (max-width:780px){ .grid{grid-template-columns:1fr} }

  .setting{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
  .setting h4{margin:0 0 8px;font-size:13px;color:#cfd6e6;letter-spacing:.3px;display:flex;justify-content:space-between;gap:8px}
  .suffix{font-weight:700;color:#a6ffd1;font-size:12px}
  .ctrl{display:grid;grid-template-columns:64px 1fr 64px;gap:10px;align-items:center}
  .ctrl button{height:56px;border-radius:12px;font-size:28px;display:grid;place-items:center;background:linear-gradient(180deg,#1e2431,#171c27);border:1px solid var(--border)}
  .ctrl button:active{transform:scale(.98)}
  .value{border:1px solid var(--border);height:56px;border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:18px;letter-spacing:.5px;background:#222;transition:background-color .15s linear}

  textarea{width:100%;min-height:110px;resize:vertical;padding:10px;border-radius:12px;outline:none;background:var(--card);color:#text;border:1px solid var(--border);color:var(--text)}
  .help{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:#cfd6e6}
  .danger{color:#ffb0b0}
  .hr{height:1px;background:var(--border);margin:12px 0}

  .presets{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
  .presets::-webkit-scrollbar{height:8px}
  .presets::-webkit-scrollbar-thumb{background:#2a3242;border-radius:999px}
  .preset{flex:0 0 240px;scroll-snap-align:start;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}

  .stars{display:flex;gap:6px}
  .starbtn{background:transparent;border:none;padding:0;cursor:pointer;display:grid;place-items:center}
  .star svg{width:22px;height:22px;fill:#3a3a3a}
  .star.on svg{fill:#ffd43b;filter:drop-shadow(0 0 4px rgba(255,212,59,.25))}
  .badge{font-size:11px;color:#7bd890;border:1px solid #2e3a2e;background:#163016;padding:2px 6px;border-radius:999px}

  /* Lock visuals */
  .lock-badge{font-size:11px;color:#ffb7b7;border:1px solid #3a2626;background:#2a1717;padding:2px 6px;border-radius:999px}
  .locked .ctrl button{opacity:.4;pointer-events:none}
  .locked .value{filter:grayscale(.4) brightness(.9)}
  .locked textarea{opacity:.6;pointer-events:none}
  .locked .starbtn{opacity:.4;pointer-events:none}
  button:disabled{opacity:.5;pointer-events:none}
</style>

<!-- Dropbox SDK -->
<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
</head>
<body>
<header>
  <div class="wrap title">
    <div class="logo">M</div>
    <h1>Matty's 890 Tweaks</h1>
    <div class="status">
      <span class="status-dot ok" id="syncDot"></span>
      <span id="syncText">Loading…</span>
      <span id="errTip" style="display:none"></span>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <!-- LEFT -->
    <aside class="panel">
      <h2>Scenarios</h2>
      <div class="toolbar" style="margin-bottom:10px">
        <button class="btn brand" id="addScenarioBtn">+ New Scenario</button>
        <button class="btn ghost" id="renameScenarioBtn">Rename</button>
        <button class="btn ghost danger" id="deleteScenarioBtn">Delete</button>
      </div>
      <div id="scenarioList" class="scenarios"></div>
      <div class="hr"></div>

      <h2>Read-only Presets</h2>
      <div class="presets" id="presetGrid"></div>

      <div class="hr"></div>
      <div class="toolbar">
        <button class="btn" id="openSettings">Settings</button>
        <button class="btn" id="aiSuggestBtn">Suggest Settings (Beta)</button>
        <button class="btn ghost" id="toggleLockBtn">Lock</button>
        <span class="pill">Autosave + Dropbox</span>
      </div>
    </aside>

    <!-- RIGHT -->
    <section class="panel" id="detailPanel">
      <h2 id="currentTitle">—</h2>
      <div class="card" style="margin-bottom:14px">
        <span class="badge" id="lockBadge" style="display:none">locked</span>
      </div>

      <div class="grid">
        <!-- FRONT -->
        <div class="card">
          <h3 style="margin:0 0 10px 0">Front</h3>

          <div class="setting" data-setting="front.preload">
            <h4>PRELOAD <span class="suffix" id="suffix-front.preload"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.preload">-</button>
              <div class="value" id="front.preload">0</div>
              <button data-delta="1" data-path="front.preload">+</button>
            </div>
          </div>

          <div class="setting" data-setting="front.comp">
            <h4>COMP <span class="suffix" id="suffix-front.comp"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.comp">-</button>
              <div class="value" id="front.comp">0</div>
              <button data-delta="1" data-path="front.comp">+</button>
            </div>
          </div>

          <div class="setting" data-setting="front.reb">
            <h4>REB <span class="suffix" id="suffix-front.reb"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.reb">-</button>
              <div class="value" id="front.reb">0</div>
              <button data-delta="1" data-path="front.reb">+</button>
            </div>
          </div>
        </div>

        <!-- REAR -->
        <div class="card">
          <h3 style="margin:0 0 10px 0">Rear</h3>

          <div class="setting" data-setting="rear.preload">
            <h4>PRELOAD <span class="suffix" id="suffix-rear.preload"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.preload">-</button>
              <div class="value" id="rear.preload">0</div>
              <button data-delta="1" data-path="rear.preload">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.lsc">
            <h4>LS COMP <span class="suffix" id="suffix-rear.lsc"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.lsc">-</button>
              <div class="value" id="rear.lsc">0</div>
              <button data-delta="1" data-path="rear.lsc">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.hsc">
            <h4>HS COMP <span class="suffix" id="suffix-rear.hsc"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.hsc">-</button>
              <div class="value" id="rear.hsc">0</div>
              <button data-delta="1" data-path="rear.hsc">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.reb">
            <h4>REB <span class="suffix" id="suffix-rear.reb"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.reb">-</button>
              <div class="value" id="rear.reb">0</div>
              <button data-delta="1" data-path="rear.reb">+</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 10px 6px">Notes <span class="badge" style="margin-left:8px">live-saved</span></h3>
        <textarea id="notes" placeholder="Ride impressions, terrain, tyres, clicker changes..."></textarea>

        <div class="hr"></div>

        <h3 style="margin:0 0 10px 6px">Ratings (1-5)</h3>
        <div class="row" id="ratingsRow"></div>
        <div class="help" style="margin-top:8px">Comfort higher = softer bias. Stability higher = firmer bias.</div>
      </div>
    </section>
  </div>
</main>

<!-- Settings dialog -->
<dialog id="settingsDlg" style="border:none;border-radius:16px;padding:0;max-width:560px;width:95%">
  <div class="panel" style="border-radius:16px">
    <h2>Settings</h2>
    <div class="row">
      <label class="pill">Dropbox file path</label>
      <input id="dbxPath" class="btn" style="flex:1;text-align:left" />
    </div>
    <div class="row" style="margin-top:10px">
      <label class="pill">Access token</label>
      <input id="dbxToken" class="btn" style="flex:1;text-align:left" placeholder="Paste your Dropbox token" />
    </div>
    <div class="help" style="margin-top:8px">Use App-Folder token; path should be <b>/suspension.json</b>.</div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn ghost" id="closeSettings">Close</button>
      <button class="btn brand" id="saveSettings">Save</button>
    </div>
  </div>
</dialog>

<script>
/* ====== KEYS & DEFAULTS ====== */
const LOCAL_KEY = 'matty890.v5';
const TOKEN_KEY = 'matty890.dbx.token';
const PATH_KEY  = 'matty890.dbx.path';
const DEFAULT_DBX_PATH = '/suspension.json'; // App-Folder safe

/* ====== RANGES & PRESETS ====== */
const RANGES = {
  'front.preload': { unit:'+',     values:[0,1,2,3],                                  labels:{0:'Comfort',3:'Loaded'},                 softIncreasing:false },
  'front.comp':    { unit:'clicks',values:[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5], labels:{20:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  },
  'front.reb':     { unit:'clicks',values:[22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5],     labels:{18:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  },
  'rear.preload':  { unit:'turns', values:[1,2,3,4,5,6,7,8,9,10,11,12],              labels:{4:'Comf/Std/Sport',10:'Loaded'},         softIncreasing:false },
  'rear.lsc':      { unit:'clicks',values:[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4], labels:{20:'Comfort',15:'Standard',10:'Sport',7:'Full Payload'}, softIncreasing:true },
  'rear.hsc':      { unit:'turns', values:[2,1.5,1,0.5],                              labels:{2:'Comfort',1.5:'Standard',1:'Sport',0.5:'Loaded'}, softIncreasing:true },
  'rear.reb':      { unit:'clicks',values:[22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5],     labels:{18:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  }
};

const DEFAULT_SCENARIOS = {
  'Comfort':  { front:{preload:0, comp:20, reb:18}, rear:{preload:4, lsc:20, hsc:2,   reb:18}, notes:'Comfort baseline', locked:false, ratings:{} },
  'Standard': { front:{preload:1, comp:15, reb:15}, rear:{preload:4, lsc:15, hsc:1.5, reb:15}, notes:'Standard baseline', locked:false, ratings:{} },
  'Sport':    { front:{preload:1, comp:10, reb:10}, rear:{preload:4, lsc:10, hsc:1,   reb:10}, notes:'Sport baseline',   locked:false, ratings:{} },
  'Loaded':   { front:{preload:3, comp:15, reb:15}, rear:{preload:10,lsc:7,  hsc:0.5, reb:15}, notes:'Loaded baseline',  locked:false, ratings:{} }
};

const initialData = {
  current: 'High Speed Naked',
  scenarios: {
    'High Speed Naked': { front:{preload:0, comp:15, reb:15}, rear:{preload:4, lsc:15, hsc:1.5, reb:15}, notes:'', ratings:{}, locked:false },
    'Loaded Touring':   { front:{preload:3, comp:15, reb:15}, rear:{preload:10,lsc:7,  hsc:0.5, reb:15}, notes:'', ratings:{}, locked:false },
    'Enduro / Singles': { front:{preload:1, comp:18, reb:16}, rear:{preload:5, lsc:18, hsc:1.5, reb:16}, notes:'', ratings:{}, locked:false }
  },
  updatedAt: new Date().toISOString()
};

const CATS = [
  'High-Speed Comfort',
  'Singles Comfort',
  'High-Speed Stability',
  'Front Grip',
  'Rear Traction',
  'Brake Dive'
];

/* ====== STATE & UTILS ====== */
let data = initialData;
let dbx = null;
let syncTimer = null;

function $(id){ return document.getElementById(id); }
function setStatus(state,text){
  $('syncDot').className='status-dot '+(state==='ok'?'ok':state==='sync'?'sync':'err');
  $('syncText').textContent=text;
}
function showErrTip(msg){ $('errTip').style.display='inline'; $('errTip').textContent=msg||''; }
function hideErrTip(){ $('errTip').style.display='none'; }

/* ====== LOCAL STORAGE ====== */
function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LOCAL_KEY)); }catch{ return null; } }
function saveLocal(){ data.updatedAt=new Date().toISOString(); localStorage.setItem(LOCAL_KEY, JSON.stringify(data)); }

/* ====== DROPBOX ====== */
async function ensureDropbox(){
  const token = (localStorage.getItem(TOKEN_KEY)||'').trim();
  if(!token) return null;
  if(!dbx) dbx = new Dropbox.Dropbox({ accessToken: token });
  return dbx;
}
function explainDropboxError(e){
  try{
    const status = e && (e.status || e.statusCode) ? `HTTP ${e.status || e.statusCode} ` : '';
    if(e && e.error) return status + (typeof e.error==='string'? e.error : (e.error.error_summary || JSON.stringify(e.error)));
    return status + (e && e.message || 'Unknown error');
  }catch{ return 'Unknown error'; }
}
function withTimeout(promise, ms, label='operation'){
  return Promise.race([
    promise,
    new Promise((_,rej)=>setTimeout(()=>rej(new Error(label+' timeout')), ms))
  ]);
}
function blobFromDropboxDownload(resp){
  if (!resp) return null;
  if (resp.fileBlob instanceof Blob) return resp.fileBlob;
  if (resp.result && resp.result.fileBlob instanceof Blob) return resp.result.fileBlob;
  if (resp.fileBinary) return new Blob([resp.fileBinary]);
  if (resp.result && resp.result.fileBinary) return new Blob([resp.result.fileBinary]);
  if (resp.blob instanceof Blob) return resp.blob;
  if (resp.result instanceof Blob) return resp.result;
  if (resp instanceof Blob) return resp;
  return null;
}
async function loadFromDropboxFirst(){
  const token = (localStorage.getItem(TOKEN_KEY)||'').trim();
  const path  = (localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH).trim() || '/suspension.json';

  const fallbackLocal=()=>{
    const local = loadLocal(); data = local || initialData;
  };

  if(!token){
    fallbackLocal();
    setStatus('err','No Dropbox token — using local data');
    showErrTip('Open Settings and paste your Dropbox token, path: /suspension.json');
    return;
  }

  try{
    const cli = await ensureDropbox();
    const resp = await withTimeout(cli.filesDownload({ path }), 6000, 'Dropbox load');
    const blob = blobFromDropboxDownload(resp);
    if (!blob) throw new Error('No file blob returned from Dropbox');
    const text = await blob.text();
    const cloud = JSON.parse(text);
    if(cloud && cloud.scenarios){
      data = cloud; saveLocal();
      setStatus('ok','Loaded from Dropbox'); hideErrTip(); return;
    }
    fallbackLocal(); setStatus('err','Dropbox file invalid — using local data');
  }catch(e){
    console.warn('Dropbox load failed:', e);
    fallbackLocal();
    setStatus('err','Dropbox load failed — using local data');
    showErrTip(explainDropboxError(e));
  }
}
async function syncToDropbox(){
  try{
    const cli = await ensureDropbox();
    if(!cli){ setStatus('ok','Saved locally'); return; }
    const path = (localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH).trim() || '/suspension.json';
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    await withTimeout(cli.filesUpload({ path, contents: blob, mode:{'.tag':'overwrite'}, mute:true }), 6000, 'Dropbox save');
    setStatus('ok','All changes saved'); hideErrTip();
  }catch(e){
    console.error('Dropbox upload failed:', e);
    setStatus('err','Dropbox error (saved locally)');
    showErrTip(explainDropboxError(e));
  }
}
function debounceSync(){ clearTimeout(syncTimer); syncTimer = setTimeout(syncToDropbox, 600); setStatus('sync','Syncing…'); }

/* ====== RANGE HELPERS & COLOR ====== */
function valuesFor(path){ return RANGES[path].values; }
function labelsFor(path){ return RANGES[path].labels || {}; }
function unitFor(path){ return RANGES[path].unit || ''; }
function idxOf(path,val){ return valuesFor(path).findIndex(v=>v===val); }
function nextVal(path,val,delta){ const arr=valuesFor(path); let i=idxOf(path,val); if(i===-1)i=0; i=Math.min(arr.length-1,Math.max(0,i+(delta>0?1:-1))); return arr[i]; }
function labelFor(path,val){ const lbls=labelsFor(path); return (val in lbls)?lbls[val]:''; }
// 0=hard/firm/slow(red) .. 1=soft/fast/quick(green)
function softness(path,val){
  const arr=valuesFor(path); const n=arr.length-1||1;
  let idx=arr.findIndex(v=>v===val); if(idx<0) idx=0;
  const ascending = arr[0] <= arr[arr.length-1];
  const posFromLow = ascending ? (idx/n) : (1-idx/n);
  return RANGES[path].softIncreasing ? posFromLow : (1-posFromLow);
}
function colorFor(path,val){ const s=softness(path,val); const hue=0+120*s; return `hsl(${hue.toFixed(0)} 70% 32%)`; }
function displayText(path,val){
  const u=unitFor(path);
  if(u==='turns') return `${val} ${val===1?'turn':'turns'}`;
  if(u==='+') return `${val} +`;
  if(u==='clicks') return `${val} click${val===1?'':'s'}`;
  return `${val} ${u}`.trim();
}

/* ====== LOCK & STATE ====== */
function cur(){ return data.scenarios[data.current]; }
function isLocked(){ return !!cur().locked; }
function applyLockedUI(){
  const locked=isLocked();
  $('detailPanel').classList.toggle('locked',locked);
  $('lockBadge').style.display=locked?'inline-block':'none';
  document.querySelectorAll('.ctrl button').forEach(b=>b.disabled=locked);
  document.querySelectorAll('#presetGrid button').forEach(b=>b.disabled=locked);
  $('notes').readOnly=locked;
  $('aiSuggestBtn').disabled=locked;
  $('renameScenarioBtn').disabled=locked;
  $('deleteScenarioBtn').disabled=locked;
  $('toggleLockBtn').textContent = locked ? 'Unlock' : 'Lock';
}

/* ====== RENDER ====== */
function get(path){ const [g,k]=path.split('.'); return data.scenarios[data.current][g][k]; }
function set(path,value){ const [g,k]=path.split('.'); data.scenarios[data.current][g][k]=value; saveLocal(); updateOne(path); debounceSync(); }
function updateOne(path){
  const v=get(path); const el=$(path); const suf=$('suffix-'+path);
  el.textContent=displayText(path,v); el.style.background=colorFor(path,v); suf.textContent=labelFor(path,v);
  renderScenarioList();
}
function summaryChip(s){ return `F: ${s.front.preload}/${s.front.comp}/${s.front.reb} | R: ${s.rear.preload}/${s.rear.lsc}/${s.rear.hsc}/${s.rear.reb}`; }
function renderScenarioList(){
  const list=$('scenarioList'); list.innerHTML='';
  Object.keys(data.scenarios).forEach(name=>{
    const s=data.scenarios[name];
    const div=document.createElement('div'); div.className='scenario-item'+(data.current===name?' active':'');
    div.innerHTML=`<div class="scenario-title">${name}${s.locked?'<span class="padlock">[locked]</span>':''}</div>
                   <div class="scenario-actions"><span class="pill">${summaryChip(s)}</span></div>`;
    div.onclick=()=>{ data.current=name; saveLocal(); renderAll(); debounceSync(); };
    list.appendChild(div);
  });
}
function renderPresets(){
  const g=$('presetGrid'); g.innerHTML='';
  Object.entries(DEFAULT_SCENARIOS).forEach(([name,sc])=>{
    const div=document.createElement('div');
    div.className='preset';
    div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;">
                      <strong>${name}</strong> <span class="badge">read-only</span>
                    </div>
                    <div class="help">${summaryChip(sc)}</div>
                    <div class="row" style="justify-content:flex-end">
                      <button class="btn" data-act="apply" data-name="${name}">Apply to current</button>
                      <button class="btn brand" data-act="saveas" data-name="${name}">Save as new</button>
                    </div>`;
    g.appendChild(div);
  });
  g.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      if(isLocked()) return alert('Unlock this scenario to use presets.');
      const act=btn.dataset.act, name=btn.dataset.name;
      if(act==='apply') applyPreset(name);
      if(act==='saveas') savePresetAs(name);
    });
  });
}
function renderRatings(){
  const row=$('ratingsRow'); row.innerHTML='';
  const ratings=cur().ratings||{};
  CATS.forEach(cat=>{
    const wrap=document.createElement('div');
    wrap.className='row';
    wrap.style.cssText='justify-content:space-between;background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:10px;min-width:260px;flex:1;';
    const title=document.createElement('div'); title.textContent=cat;
    const stars=document.createElement('div'); stars.className='stars';
    const val=ratings[cat]||0;
    for(let i=1;i<=5;i++){
      const b=document.createElement('button'); b.className='starbtn';
      b.innerHTML=`<span class="star ${i<=val?'on':''}"><svg viewBox="0 0 24 24"><path d="M12 17.27l5.18 3.05-1.4-5.99L20 9.24l-6.05-.52L12 3.5 10.05 8.7 4 9.24l4.22 5.09-1.4 5.99L12 17.27z"/></svg></span>`;
      b.title=i+' / 5';
      b.onclick=()=>{ if(isLocked()) return; ratings[cat]=i; cur().ratings=ratings; saveLocal(); debounceSync(); renderRatings(); };
      stars.appendChild(b);
    }
    wrap.appendChild(title); wrap.appendChild(stars); row.appendChild(wrap);
  });
}
function renderValues(){
  Object.keys(RANGES).forEach(updateOne);
  $('currentTitle').textContent=data.current;
  $('notes').value=cur().notes||'';
  renderRatings();
  applyLockedUI();
}
function renderAll(){ renderScenarioList(); renderPresets(); renderValues(); }

/* ====== PRESETS & SUGGEST ====== */
function applyPreset(name){ const p=DEFAULT_SCENARIOS[name]; if(!p) return; const c=cur(); c.front={...p.front}; c.rear={...p.rear}; saveLocal(); renderValues(); debounceSync(); }
function savePresetAs(name){
  const newName=prompt(`Save "${name}" as:`, name+' Copy'); if(!newName) return;
  if(data.scenarios[newName]) return alert('That name already exists.');
  data.scenarios[newName]=JSON.parse(JSON.stringify(DEFAULT_SCENARIOS[name]));
  data.scenarios[newName].notes=DEFAULT_SCENARIOS[name].notes+' (copied)';
  data.scenarios[newName].ratings={}; data.scenarios[newName].locked=false;
  data.current=newName; saveLocal(); renderAll(); debounceSync();
}
function shift(path,val,clicks){
  const arr=valuesFor(path); let idx=arr.findIndex(v=>v===val); if(idx<0) idx=0;
  const dir=RANGES[path].softIncreasing?1:-1; const t=Math.min(arr.length-1,Math.max(0,idx+clicks*dir));
  return arr[t];
}
function suggestSettings(c){
  const txt=(c.notes||'').toLowerCase(); const r=c.ratings||{};
  const hs=r['High-Speed Comfort']||0, sg=r['Singles Comfort']||0, stab=r['High-Speed Stability']||0;
  let b='Standard'; if(/loaded|luggage|panniers|two-up|two up/.test(txt)) b='Loaded'; else if((stab>=4&&hs<=3)||/track|sport|aggressive|wobble|wallow/.test(txt)) b='Sport'; else if((hs+sg)/2>=4) b='Comfort';
  let s=JSON.parse(JSON.stringify(DEFAULT_SCENARIOS[b]));
  if(/harsh|chatter|spike|too firm/.test(txt)){ s.front.comp=shift('front.comp',s.front.comp,+2); s.rear.lsc=shift('rear.lsc',s.rear.lsc,+2); s.rear.hsc=shift('rear.hsc',s.rear.hsc,+1); }
  if(/soft|wallow|wobbly|floaty/.test(txt)){ s.front.comp=shift('front.comp',s.front.comp,-2); s.rear.lsc=shift('rear.lsc',s.rear.lsc,-2); s.rear.hsc=shift('rear.hsc',s.rear.hsc,-1); }
  if(/pogo|kicks back|bucking/.test(txt)){ s.front.reb=shift('front.reb',s.front.reb,-2); s.rear.reb=shift('rear.reb',s.rear.reb,-2); }
  if(/packs|slow rebound|doesn'?t extend/.test(txt)){ s.front.reb=shift('front.reb',s.front.reb,+2); s.rear.reb=shift('rear.reb',s.rear.reb,+2); }
  if(/dives|braking/.test(txt)){ s.front.preload=shift('front.preload',s.front.preload,-1); s.front.comp=shift('front.comp',s.front.comp,-1); }
  if(/bottom|bottoms|smashes/.test(txt)){ s.front.preload=shift('front.preload',s.front.preload,-1); s.rear.preload=shift('rear.preload',s.rear.preload,-1); s.rear.hsc=shift('rear.hsc',s.rear.hsc,-1); }
  const comfortAvg=(hs+sg)/2; if(comfortAvg>=4){ s.front.comp=shift('front.comp',s.front.comp,+1); s.rear.lsc=shift('rear.lsc',s.rear.lsc,+1); }
  if(stab>=4){ s.front.comp=shift('front.comp',s.front.comp,-1); s.rear.lsc=shift('rear.lsc',s.rear.lsc,-1); }
  return s;
}

/* ====== EVENTS ====== */
document.addEventListener('click', e=>{
  const btn = e.target.closest('button[data-path]'); if(!btn) return;
  if(isLocked()) return;
  const path = btn.dataset.path, delta = parseInt(btn.dataset.delta,10);
  set(path, nextVal(path, get(path), delta));
});
$('notes').addEventListener('input', ()=>{
  if(isLocked()) return;
  cur().notes = $('notes').value; saveLocal(); debounceSync();
});
$('addScenarioBtn').onclick=()=>{
  const name=prompt('New scenario name:','Custom Setup'); if(!name) return;
  if(data.scenarios[name]) return alert('That scenario already exists.');
  data.scenarios[name]={ front:{preload:0,comp:20,reb:18}, rear:{preload:4,lsc:20,hsc:2,reb:18}, notes:'', ratings:{}, locked:false };
  data.current=name; saveLocal(); renderAll(); debounceSync();
};
$('renameScenarioBtn').onclick=()=>{
  if(isLocked()) return alert('Unlock this scenario to rename.');
  const newName=prompt('Rename scenario:', data.current); if(!newName||newName===data.current) return;
  if(data.scenarios[newName]) return alert('Name already exists.');
  data.scenarios[newName]=data.scenarios[data.current]; delete data.scenarios[data.current];
  data.current=newName; saveLocal(); renderAll(); debounceSync();
};
$('deleteScenarioBtn').onclick=()=>{
  if(isLocked()) return alert('Unlock this scenario to delete.');
  if(!confirm(`Delete "${data.current}"? This cannot be undone.`)) return;
  const names=Object.keys(data.scenarios).filter(n=>n!==data.current);
  delete data.scenarios[data.current];
  data.current=names[0]||'New Setup';
  if(!data.scenarios[data.current]) data.scenarios[data.current]={ front:{preload:0,comp:20,reb:18}, rear:{preload:4,lsc:20,hsc:2,reb:18}, notes:'', ratings:{}, locked:false };
  saveLocal(); renderAll(); debounceSync();
};
$('openSettings').onclick=()=>{
  $('dbxToken').value=localStorage.getItem(TOKEN_KEY)||'';
  $('dbxPath').value=localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH;
  $('settingsDlg').showModal();
};
$('closeSettings').onclick=()=>$('settingsDlg').close();
$('saveSettings').onclick=()=>{
  localStorage.setItem(TOKEN_KEY, ($('dbxToken').value||'').trim());
  localStorage.setItem(PATH_KEY,  ($('dbxPath').value||'').trim()||DEFAULT_DBX_PATH);
  dbx=null;
  $('settingsDlg').close();
  // Immediately pull cloud so device has latest
  loadFromDropboxFirst().then(()=>renderAll());
};
$('toggleLockBtn').onclick=()=>{
  const s=cur();
  if(!s.locked) s.locked=true; else { if(!confirm('Unlock this scenario to allow changes?')) return; s.locked=false; }
  saveLocal(); applyLockedUI(); renderScenarioList(); debounceSync();
};
$('aiSuggestBtn').onclick=()=>{
  if(isLocked()) return alert('Unlock this scenario to apply suggestions.');
  const s=suggestSettings(cur()); if(!s) return alert('Could not create suggestion.');
  if(confirm('Apply suggested settings to current scenario?\n\n'+summaryChip(s))){
    const c=cur(); c.front=s.front; c.rear=s.rear; saveLocal(); renderValues(); debounceSync();
  }
};

/* ====== STARTUP ====== */
(async function init(){
  // If no token, render immediately so user can open Settings
  const hasToken = !!(localStorage.getItem(TOKEN_KEY)||'').trim();
  if(!hasToken){
    const local = loadLocal(); if(local) data=local;
    renderAll();
    setStatus('err','No Dropbox token — using local data');
    showErrTip('Open Settings and paste your Dropbox token; path: /suspension.json');
    return;
  }
  // Try Dropbox first (with timeout), then render
  await loadFromDropboxFirst();
  renderAll();
})();
</script>
</body>
</html>
