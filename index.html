<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MdC Bike Tuner</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cg fill='none' stroke='%23ff6a00' stroke-width='5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='10' cy='54' r='7'/%3E%3Ccircle cx='54' cy='10' r='7'/%3E%3Cpath d='M15 49L49 15'/%3E%3Cpath d='M20 44l24-24'/%3E%3Cpath d='M25 39l14-14'/%3E%3Crect x='13' y='25' width='16' height='10' rx='3' transform='rotate(-45 13 25)'/%3E%3Crect x='35' y='47' width='16' height='10' rx='3' transform='rotate(-45 35 47)'/%3E%3Cpath d='M10 51v6M7 54h6'/%3E%3C/g%3E%3C/svg%3E">
<style>
  :root { --bg:#0f1115; --panel:#161a20; --muted:#8a93a6; --text:#e9edf3; --brand:#ff6a00; --ok:#20c997; --warn:#ffd43b; --err:#ff6b6b; --chip:#202633; --card:#121620; --border:#232938; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:linear-gradient(120deg,#0d1016,#121823 60%,#0d1016);min-height:100vh}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(150%) blur(8px);background:rgba(15,17,21,.6);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .title{display:flex;align-items:center;gap:10px}
  .logo{width:32px;height:32px;display:grid;place-items:center}
  .logo svg{width:100%;height:100%}
  h1{font-size:20px;margin:0}
  .status{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px}
  .status-dot{width:8px;height:8px;border-radius:50%}
  .ok{background:var(--ok)} .sync{background:var(--warn)} .err{background:var(--err)}
  #errTip{color:#ffd43b}
  .head-actions{display:flex;gap:8px;align-items:center}

  main .wrap{display:grid;grid-template-columns:340px 1fr;gap:18px;padding-top:18px;align-items:start}
  @media (max-width:980px){ main .wrap{grid-template-columns:1fr} }

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
  .panel h2{margin:4px 0 12px;font-size:14px;color:#cfd6e6;letter-spacing:.3px}

  .btn,button{background:linear-gradient(180deg,#222a39,#1a202e);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;letter-spacing:.2px;transition:.12s}
  .btn:hover{border-color:#344055;transform:translateY(-1px)}
  .btn.ghost{background:transparent}
  .btn.brand{background:linear-gradient(180deg,#ff7a1d,#ff6a00);color:#111;border:none}

  .list{display:flex;flex-direction:column;gap:8px}
  .item{position:relative;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 90px 10px 10px;display:flex;gap:10px;align-items:center;cursor:pointer;transition:.15s}
  .item:hover{transform:translateY(-1px);border-color:#2b3244}
  .item.active{outline:2px solid var(--brand);box-shadow:0 0 0 4px #ff6a001a}
  .item-title{font-weight:700}
  .item-sub{font-size:12px;color:#9fb0c7}
  .lock-inline{position:absolute;right:10px;top:50%;transform:translateY(-50%);min-width:80px;text-transform:uppercase}
  .lock-inline.locked{font-weight:900;outline:2px solid #ffb3b3;background:#2a1717;border-color:#3a2626}
  .lock-inline.unlocked{opacity:.7}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media (max-width:780px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}

  .setting{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
  .setting h4{margin:0 0 8px;font-size:13px;color:#cfd6e6;letter-spacing:.3px;display:flex;justify-content:space-between;gap:8px}
  .suffix{font-weight:700;color:#a6ffd1;font-size:12px;min-width:120px;text-align:right}
  .ctrl{display:grid;grid-template-columns:76px 1fr 76px;gap:10px;align-items:center}
  .ctrl button{height:64px;border-radius:12px;font-size:32px;display:grid;place-items:center;background:linear-gradient(180deg,#1e2431,#171c27);border:1px solid var(--border)}
  .ctrl button:active{transform:scale(.98)}
  .value{border:1px solid var(--border);height:64px;border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:18px;letter-spacing:.5px;background:#222;transition:background-color .15s linear}
  .value small{display:block;font-weight:600;color:#d1d7e6;opacity:.9;margin-top:2px;font-size:11px}

  textarea{width:100%;min-height:110px;resize:vertical;padding:10px;border-radius:12px;outline:none;background:var(--card);color:var(--text);border:1px solid var(--border)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hr{height:1px;background:var(--border);margin:12px 0}
  .pill{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:#cfd6e6}

  /* Presets vertical */
  .preset-col{display:flex;flex-direction:column;gap:8px}
  .preset-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}

  /* Stars */
  .stars{display:flex;gap:6px}
  .starbtn{background:transparent;border:none;padding:0;cursor:pointer;display:grid;place-items:center}
  .star svg{width:22px;height:22px;fill:#3a3a3a}
  .star.on svg{fill:#ffd43b;filter:drop-shadow(0 0 4px rgba(255,212,59,.25))}
</style>

<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
</head>
<body>
<header>
  <div class="wrap title">
    <div class="logo" aria-hidden="true">
      <!-- Shock outline icon (brand orange) -->
      <svg viewBox="0 0 64 64" fill="none" stroke="#ff6a00" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="10" cy="54" r="7"/>
        <circle cx="54" cy="10" r="7"/>
        <path d="M15 49L49 15M20 44l24-24M25 39l14-14"/>
        <rect x="13" y="26" width="16" height="9" rx="3" transform="rotate(-45 13 26)"/>
        <rect x="35" y="46" width="16" height="9" rx="3" transform="rotate(-45 35 46)"/>
        <path d="M10 51v6M7 54h6"/>
      </svg>
    </div>
    <h1>MdC Bike Tuner</h1>
    <div class="status">
      <span class="status-dot ok" id="syncDot"></span>
      <span id="syncText">Loading…</span>
      <span id="errTip" style="display:none"></span>
    </div>
    <div class="head-actions">
      <button class="btn" id="signinBtn">Sign into Dropbox</button>
      <button class="btn" id="openSettings">Settings</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <!-- LEFT -->
    <aside>
      <!-- BIKES -->
      <section class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">Bikes</h2>
          <button class="btn brand" id="addBikeBtn">+ Add Bike</button>
        </div>
        <div id="bikeList" class="list"></div>
      </section>

      <!-- SCENARIOS -->
      <section class="panel" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">Scenarios</h2>
          <div class="row">
            <button class="btn" id="addScenarioBtn">+ New</button>
            <button class="btn ghost" id="renameScenarioBtn">Rename</button>
            <button class="btn ghost danger" id="deleteScenarioBtn">Delete</button>
          </div>
        </div>
        <div id="scenarioList" class="list"></div>
      </section>

      <!-- PRESETS -->
      <section class="panel" style="margin-top:12px">
        <h2 style="margin:0 0 8px 0">Presets</h2>
        <div id="presetCol" class="preset-col"></div>
      </section>
    </aside>

    <!-- RIGHT -->
    <section class="panel" id="detailPanel">
      <h2 id="currentTitle" style="margin:0 0 10px 0">—</h2>

      <div class="grid">
        <!-- FRONT -->
        <div class="card" id="frontCard">
          <h3 style="margin:0 0 10px 0">Front</h3>

          <div class="setting" data-setting="front.preload">
            <h4>PRELOAD <span class="suffix" id="suffix-front.preload"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.preload">−</button>
              <div class="value" id="front.preload">0<small>T‑Grip CW</small></div>
              <button data-delta="1" data-path="front.preload">+</button>
            </div>
          </div>

          <div class="setting" data-setting="front.comp">
            <h4>COMP <span class="suffix" id="suffix-front.comp"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.comp">−</button>
              <div class="value" id="front.comp">0<small>clicks CCW</small></div>
              <button data-delta="1" data-path="front.comp">+</button>
            </div>
          </div>

          <div class="setting" data-setting="front.reb">
            <h4>REB <span class="suffix" id="suffix-front.reb"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.reb">−</button>
              <div class="value" id="front.reb">0<small>clicks CCW</small></div>
              <button data-delta="1" data-path="front.reb">+</button>
            </div>
          </div>

          <!-- Fork height −30..0 mm (0 = green) -->
          <div class="setting" data-setting="front.forkHeight">
            <h4>FORK HEIGHT <span class="suffix" id="suffix-front.forkHeight"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="front.forkHeight">−</button>
              <div class="value" id="front.forkHeight">0<small>mm</small></div>
              <button data-delta="1" data-path="front.forkHeight">+</button>
            </div>
          </div>
        </div>

        <!-- REAR -->
        <div class="card" id="rearCard">
          <h3 style="margin:0 0 10px 0">Rear</h3>

          <div class="setting" data-setting="rear.preload">
            <h4>PRELOAD <span class="suffix" id="suffix-rear.preload"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.preload">−</button>
              <div class="value" id="rear.preload">0<small>turns CW</small></div>
              <button data-delta="1" data-path="rear.preload">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.lsc">
            <h4>LS COMP <span class="suffix" id="suffix-rear.lsc"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.lsc">−</button>
              <div class="value" id="rear.lsc">0<small>clicks CCW</small></div>
              <button data-delta="1" data-path="rear.lsc">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.hsc">
            <h4>HS COMP <span class="suffix" id="suffix-rear.hsc"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.hsc">−</button>
              <div class="value" id="rear.hsc">0<small>turns CCW</small></div>
              <button data-delta="1" data-path="rear.hsc">+</button>
            </div>
          </div>

          <div class="setting" data-setting="rear.reb">
            <h4>REB <span class="suffix" id="suffix-rear.reb"></span></h4>
            <div class="ctrl">
              <button data-delta="-1" data-path="rear.reb">−</button>
              <div class="value" id="rear.reb">0<small>clicks CCW</small></div>
              <button data-delta="1" data-path="rear.reb">+</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 10px 6px">Notes</h3>
        <textarea id="notes" placeholder="Ride impressions, terrain, tyres, clicker changes..."></textarea>

        <div class="hr"></div>

        <h3 style="margin:0 0 10px 6px">Ratings (1–5)</h3>
        <div class="row" id="ratingsRow"></div>
      </div>
    </section>
  </div>
</main>

<!-- SETTINGS -->
<dialog id="settingsDlg" style="border:none;border-radius:16px;padding:0;max-width:620px;width:95%">
  <div class="panel" style="border-radius:16px">
    <h2>Settings</h2>
    <div class="row">
      <label class="pill">Dropbox file path</label>
      <input id="dbxPath" class="btn" style="flex:1;text-align:left"/>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="pill">Access token</label>
      <input id="dbxToken" class="btn" style="flex:1;text-align:left" placeholder="Paste your Dropbox token"/>
    </div>
    <div class="help" style="margin-top:8px">Use App‑Folder token; path should be <b>/suspension.json</b>.</div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn ghost" id="closeSettings">Close</button>
      <button class="btn brand" id="saveSettings">Save</button>
    </div>
  </div>
</dialog>

<!-- ADD BIKE -->
<dialog id="addBikeDlg" style="border:none;border-radius:16px;padding:0;max-width:640px;width:95%">
  <div class="panel" style="border-radius:16px">
    <h2>Add Bike</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div><label style="font-size:12px;color:#cfd6e6">Year</label><input id="bikeYear" type="number" placeholder="2023" class="btn" style="width:100%"/></div>
      <div><label style="font-size:12px;color:#cfd6e6">Make</label><input id="bikeMake" placeholder="KTM" class="btn" style="width:100%"/></div>
      <div><label style="font-size:12px;color:#cfd6e6">Model</label><input id="bikeModel" placeholder="890 Adventure" class="btn" style="width:100%"/></div>
      <div><label style="font-size:12px;color:#cfd6e6">Rego</label><input id="bikeRego" placeholder="ABC‑123" class="btn" style="width:100%"/></div>
      <div style="grid-column:1 / -1">
        <label style="font-size:12px;color:#cfd6e6">Photo</label>
        <div id="photoPreview" style="width:100%;height:140px;border:1px dashed #2b3244;border-radius:10px;display:grid;place-items:center;color:#8aa;overflow:hidden">Drop or pick an image</div>
        <input id="bikePhoto" type="file" accept="image/*" style="margin-top:8px"/>
      </div>
    </div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn ghost" id="cancelAddBike">Cancel</button>
      <button class="btn brand" id="confirmAddBike">Add Bike</button>
    </div>
  </div>
</dialog>

<script>
/* ========= CONSTANTS ========= */
const LOCAL_KEY = 'mdc.tuner.v7.multibike';
const TOKEN_KEY = 'mdc.dbx.token';
const PATH_KEY  = 'mdc.dbx.path';
const DEFAULT_DBX_PATH = '/suspension.json';

/* Ranges (incl. Fork Height −30..0, 0=green) */
const RANGES = {
  'front.preload': { unit:'+',     values:[0,1,2,3],                                  labels:{0:'Comfort',3:'Loaded'},                 softIncreasing:false },
  'front.comp':    { unit:'clicks',values:[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5], labels:{20:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  },
  'front.reb':     { unit:'clicks',values:[22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5],     labels:{18:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  },
  'front.forkHeight':{unit:'mm',   values:Array.from({length:31},(_,i)=>-30+i),        labels:{0:'Flush'}, softIncreasing:true },
  'rear.preload':  { unit:'turns', values:[1,2,3,4,5,6,7,8,9,10,11,12],              labels:{4:'Comf/Std/Sport',10:'Loaded'},         softIncreasing:false },
  'rear.lsc':      { unit:'clicks',values:[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4], labels:{20:'Comfort',15:'Standard',10:'Sport',7:'Full Payload'}, softIncreasing:true },
  'rear.hsc':      { unit:'turns', values:[2,1.5,1,0.5],                              labels:{2:'Comfort',1.5:'Standard',1:'Sport',0.5:'Loaded'}, softIncreasing:true },
  'rear.reb':      { unit:'clicks',values:[22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5],     labels:{18:'Comfort',15:'Standard/Loaded',10:'Sport'}, softIncreasing:true  }
};

const PRESETS = {
  'Comfort':  { front:{preload:0, comp:20, reb:18, forkHeight:0},   rear:{preload:4, lsc:20, hsc:2,   reb:18} },
  'Standard': { front:{preload:1, comp:15, reb:15, forkHeight:-10}, rear:{preload:4, lsc:15, hsc:1.5, reb:15} },
  'Sport':    { front:{preload:1, comp:10, reb:10, forkHeight:-20}, rear:{preload:4, lsc:10, hsc:1,   reb:10} },
  'Loaded':   { front:{preload:3, comp:15, reb:15, forkHeight:-10}, rear:{preload:10,lsc:7,  hsc:0.5, reb:15} }
};

const RATING_CATS = [
  'High-Speed Comfort',
  'Singles Comfort',
  'High-Speed Stability',
  'Front Grip',
  'Rear Traction',
  'Brake Dive'
];

/* ========= STATE ========= */
let dbx=null, syncTimer=null;
let data={ currentBikeId:null, bikes:{}, updatedAt:new Date().toISOString() };

/* ========= UTILS ========= */
const $=(id)=>document.getElementById(id);
function uid(){ return 'b_'+Math.random().toString(36).slice(2,10); }
function setStatus(s,t){ $('syncDot').className='status-dot '+(s==='ok'?'ok':s==='sync'?'sync':'err'); $('syncText').textContent=t; }
function showErr(m){ $('errTip').style.display='inline'; $('errTip').textContent=m||''; }
function hideErr(){ $('errTip').style.display='none'; }

function loadLocal(){ try{return JSON.parse(localStorage.getItem(LOCAL_KEY))}catch{return null} }
function saveLocal(){ data.updatedAt=new Date().toISOString(); localStorage.setItem(LOCAL_KEY, JSON.stringify(data)); }

/* ========= DROPBOX ========= */
async function ensureDropbox(){ const token=(localStorage.getItem(TOKEN_KEY)||'').trim(); if(!token) return null; if(!dbx) dbx=new Dropbox.Dropbox({accessToken:token}); return dbx; }
function explainDropboxError(e){ try{const s=e&&(e.status||e.statusCode)?`HTTP ${e.status||e.statusCode} `:''; if(e&&e.error) return s+(typeof e.error==='string'?e.error:(e.error.error_summary||JSON.stringify(e.error))); return s+(e&&e.message||'Unknown error');}catch{return 'Unknown error'} }
function withTimeout(p,ms,label='operation'){return Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error(label+' timeout')),ms))])}
function blobFromDropboxDownload(resp){ if(!resp) return null; if(resp.fileBlob instanceof Blob) return resp.fileBlob; if(resp.result && resp.result.fileBlob instanceof Blob) return resp.result.fileBlob; if(resp.fileBinary) return new Blob([resp.fileBinary]); if(resp.result && resp.result.fileBinary) return new Blob([resp.result.fileBinary]); if(resp.blob instanceof Blob) return resp.blob; if(resp.result instanceof Blob) return resp.result; if(resp instanceof Blob) return resp; return null; }
async function loadFromDropboxFirst(){
  const token=(localStorage.getItem(TOKEN_KEY)||'').trim();
  const path=(localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH).trim()||'/suspension.json';
  const fallback=()=>{const local=loadLocal(); if(local) data=local; else bootstrapDefault();};
  if(!token){ fallback(); setStatus('err','No Dropbox token — local only'); showErr('Open Settings and paste token.'); return; }
  try{
    const cli=await ensureDropbox();
    const resp=await withTimeout(cli.filesDownload({path}),7000,'Dropbox load');
    const blob=blobFromDropboxDownload(resp); if(!blob) throw new Error('No file blob returned from Dropbox');
    const text=await blob.text(); const cloud=JSON.parse(text);
    if(cloud && cloud.bikes){ data=cloud; saveLocal(); setStatus('ok','Loaded from Dropbox'); hideErr(); migrateIfNeeded(); return; }
    if(cloud && cloud.scenarios){ data=migrateLegacySingle(cloud); saveLocal(); setStatus('ok','Migrated legacy data'); hideErr(); return; }
    fallback(); setStatus('err','Invalid cloud data — local only');
  }catch(e){
    console.warn('Dropbox load failed:',e);
    fallback(); setStatus('err','Dropbox load failed — local only'); showErr(explainDropboxError(e));
  }
}
async function syncToDropbox(){
  try{
    const cli=await ensureDropbox(); if(!cli){ setStatus('ok','Saved locally'); return; }
    const path=(localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH).trim()||'/suspension.json';
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    await withTimeout(cli.filesUpload({path,contents:blob,mode:{'.tag':'overwrite'},mute:true}),7000,'Dropbox save');
    setStatus('ok','All changes saved'); hideErr();
  }catch(e){ console.error('Dropbox upload failed:',e); setStatus('err','Dropbox error (saved locally)'); showErr(explainDropboxError(e)); }
}
function debounceSync(){ clearTimeout(syncTimer); syncTimer=setTimeout(syncToDropbox,600); setStatus('sync','Syncing…'); }

/* ========= MIGRATION / DEFAULTS ========= */
function defaultScenarios(){ return {
  'High Speed Naked': { front:{preload:0, comp:20, reb:18, forkHeight:0},   rear:{preload:4, lsc:20, hsc:2,   reb:18}, notes:'', ratings:{}, locked:false },
  'Loaded Touring':   { front:{preload:3, comp:15, reb:15, forkHeight:-10}, rear:{preload:10,lsc:7,  hsc:0.5, reb:15}, notes:'', ratings:{}, locked:false },
  'Enduro / Singles': { front:{preload:1, comp:18, reb:16, forkHeight:-15}, rear:{preload:5, lsc:18, hsc:1.5, reb:16}, notes:'', ratings:{}, locked:false }
};}
function migrateLegacySingle(single){ const id=uid(); return { currentBikeId:id, bikes:{[id]:{meta:{year:'',make:'KTM',model:'890 Adventure',rego:'',photo:''},currentScenario:single.current||'High Speed Naked',scenarios:single.scenarios||defaultScenarios(),service:[]}}, updatedAt:new Date().toISOString() }; }
function bootstrapDefault(){ if(!data.currentBikeId){ const id=uid(); data.currentBikeId=id; data.bikes[id]={meta:{year:'',make:'KTM',model:'890 Adventure',rego:'',photo:''},currentScenario:'High Speed Naked',scenarios:defaultScenarios(),service:[]}; } }
function migrateIfNeeded(){ if(!data.bikes || !Object.keys(data.bikes).length) bootstrapDefault(); }

/* ========= MODEL ========= */
function bikeIds(){ return Object.keys(data.bikes||{}); }
function curBike(){ return data.bikes[data.currentBikeId]; }
function curScenario(){ const b=curBike(); return b.scenarios[b.currentScenario]; }
function get(path){ const [g,k]=path.split('.'); return curScenario()[g][k]; }
function set(path,val){ const [g,k]=path.split('.'); curScenario()[g][k]=val; saveLocal(); updateOne(path); debounceSync(); }

/* ========= RANGE & COLOR ========= */
function valuesFor(path){ return RANGES[path].values; }
function labelsFor(path){ return RANGES[path].labels||{}; }
function unitFor(path){ return RANGES[path].unit||''; }
function idxOf(path,val){ return valuesFor(path).findIndex(v=>v===val); }
function nextVal(path,val,delta){ const arr=valuesFor(path); let i=idxOf(path,val); if(i===-1)i=0; i=Math.min(arr.length-1,Math.max(0,i+(delta>0?1:-1))); return arr[i]; }
function labelFor(path,val){ const lbls=labelsFor(path); return (val in lbls)?lbls[val]:''; }
function softness(path,val){ const arr=valuesFor(path); const n=arr.length-1||1; let idx=arr.findIndex(v=>v===val); if(idx<0) idx=0; const ascending=arr[0]<=arr[arr.length-1]; const posFromLow=ascending?(idx/n):(1-idx/n); return RANGES[path].softIncreasing?posFromLow:(1-posFromLow); }
function colorFor(path,val){ const s=softness(path,val); const hue=0+120*s; return `hsl(${hue.toFixed(0)} 70% 32%)`; }
function displayText(path,val){ const u=unitFor(path); if(u==='turns') return `${val} ${val===1?'turn':'turns'}`; if(u==='+') return `${val} +`; if(u==='clicks') return `${val} click${val===1?'':'s'}`; if(u==='mm') return `${val} mm`; return `${val} ${u}`.trim(); }

/* ========= RENDER ========= */
function renderBikeList(){
  const list=$('bikeList'); list.innerHTML='';
  bikeIds().forEach(id=>{
    const b=data.bikes[id];
    const item=document.createElement('div'); item.className='item'+(id===data.currentBikeId?' active':'');
    const meta=`${b.meta.year||''} ${b.meta.make||''} ${b.meta.model||''}`.trim();
    const sub=b.meta.rego?`Rego ${b.meta.rego}`:'';
    const thumb=b.meta.photo?`<img src="${b.meta.photo}" alt="photo" style="width:48px;height:36px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">`:`<div style="width:48px;height:36px;border-radius:8px;border:1px dashed #2b3244;display:grid;place-items:center;color:#8aa;font-size:11px">no photo</div>`;
    item.innerHTML=`${thumb}<div><div class="item-title">${meta||'Untitled Bike'}</div><div class="item-sub">${sub}</div></div>`;
    item.onclick=(e)=>{ data.currentBikeId=id; saveLocal(); renderAll(); debounceSync(); };
    list.appendChild(item);
  });
}
function renderScenarioList(){
  const list=$('scenarioList'); list.innerHTML='';
  const b=curBike();
  Object.keys(b.scenarios).forEach(name=>{
    const s=b.scenarios[name];
    const div=document.createElement('div'); div.className='item'+(name===b.currentScenario?' active':'');
    div.innerHTML=`<div><div class="item-title">${name}</div>
      <div class="item-sub">F ${s.front.preload}/${s.front.comp}/${s.front.reb}/${s.front.forkHeight}mm | R ${s.rear.preload}/${s.rear.lsc}/${s.rear.hsc}/${s.rear.reb}</div></div>`;
    const lock=document.createElement('button');
    lock.className='btn lock-inline '+(s.locked?'locked':'unlocked');
    lock.textContent=s.locked?'LOCK':'lock';
    lock.onclick=(ev)=>{ ev.stopPropagation(); s.locked=!s.locked; saveLocal(); applyLockedUI(); renderScenarioList(); debounceSync(); };
    div.onclick=()=>{ b.currentScenario=name; saveLocal(); renderAll(); debounceSync(); };
    div.appendChild(lock);
    list.appendChild(div);
  });
}
function renderPresets(){
  const col=$('presetCol'); col.innerHTML='';
  Object.entries(PRESETS).forEach(([name,sc])=>{
    const card=document.createElement('div'); card.className='preset-card';
    card.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
        <strong>${name}</strong><span class="pill">read‑only</span></div>
      <div class="item-sub">F ${sc.front.preload}/${sc.front.comp}/${sc.front.reb}/${sc.front.forkHeight}mm | R ${sc.rear.preload}/${sc.rear.lsc}/${sc.rear.hsc}/${sc.rear.reb}</div>
      <div class="row" style="justify-content:flex-end;margin-top:6px">
        <button class="btn" data-act="apply" data-name="${name}">Apply to current</button>
        <button class="btn brand" data-act="saveas" data-name="${name}">Save as new</button>
      </div>`;
    card.querySelector('[data-act="apply"]').onclick=()=>{ if(curScenario().locked) return alert('Unlock this scenario to use presets.'); applyPreset(name); };
    card.querySelector('[data-act="saveas"]').onclick=()=>{ if(curScenario().locked) return alert('Unlock this scenario to save.'); savePresetAs(name); };
    col.appendChild(card);
  });
}
function updateOne(path){
  const v=get(path); const el=$(path); const suf=$('suffix-'+path);
  el.textContent=displayText(path,v)+el.innerHTML.replace(/^[^<]*/,'');
  el.style.background=colorFor(path,v);
  suf.textContent=labelFor(path,v);
}
function renderRatings(){
  const row=$('ratingsRow'); row.innerHTML='';
  const ratings=curScenario().ratings||{};
  ['High-Speed Comfort','Singles Comfort','High-Speed Stability','Front Grip','Rear Traction','Brake Dive'].forEach(cat=>{
    const wrap=document.createElement('div'); wrap.className='row';
    wrap.style.cssText='justify-content:space-between;background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:10px;min-width:260px;flex:1;';
    const title=document.createElement('div'); title.textContent=cat;
    const stars=document.createElement('div'); stars.className='stars';
    const val=ratings[cat]||0;
    for(let i=1;i<=5;i++){
      const b=document.createElement('button'); b.className='starbtn';
      b.innerHTML=`<span class="star ${i<=val?'on':''}"><svg viewBox="0 0 24 24"><path d="M12 17.27l5.18 3.05-1.4-5.99L20 9.24l-6.05-.52L12 3.5 10.05 8.7 4 9.24l4.22 5.09-1.4 5.99L12 17.27z"/></svg></span>`;
      b.title=i+' / 5';
      b.onclick=()=>{ if(curScenario().locked) return; ratings[cat]=i; curScenario().ratings=ratings; saveLocal(); debounceSync(); renderRatings(); };
      stars.appendChild(b);
    }
    wrap.appendChild(title); wrap.appendChild(stars); row.appendChild(wrap);
  });
}
function applyLockedUI(){
  const locked=!!curScenario().locked;
  document.querySelectorAll('.ctrl button').forEach(b=>b.disabled=locked);
  document.querySelectorAll('#presetCol button').forEach(b=>b.disabled=locked);
  $('notes').readOnly=locked;
  $('renameScenarioBtn').disabled=locked;
  $('deleteScenarioBtn').disabled=locked;
}
function renderValues(){
  ['front.preload','front.comp','front.reb','front.forkHeight','rear.preload','rear.lsc','rear.hsc','rear.reb'].forEach(updateOne);
  $('currentTitle').textContent=curBike().currentScenario;
  $('notes').value=curScenario().notes||'';
  renderRatings();
  applyLockedUI();
}
function renderAll(){ renderBikeList(); renderScenarioList(); renderPresets(); renderValues(); }

/* ========= ACTIONS ========= */
document.addEventListener('click',e=>{
  const btn=e.target.closest('button[data-path]'); if(!btn) return;
  if(curScenario().locked) return;
  const path=btn.dataset.path, delta=parseInt(btn.dataset.delta || (btn.textContent.trim()==='+'?1:-1),10);
  set(path, nextVal(path, get(path), delta));
});
$('notes').addEventListener('input',()=>{ if(curScenario().locked) return; curScenario().notes=$('notes').value; saveLocal(); debounceSync(); });

$('addScenarioBtn').onclick=()=>{
  if(curScenario().locked) return alert('Unlock current scenario first.');
  const name=prompt('New scenario name:','Custom Setup'); if(!name) return;
  const b=curBike(); if(b.scenarios[name]) return alert('That name already exists.');
  b.scenarios[name]=JSON.parse(JSON.stringify(PRESETS.Standard));
  b.scenarios[name].notes=''; b.scenarios[name].ratings={}; b.scenarios[name].locked=false;
  b.currentScenario=name; saveLocal(); renderAll(); debounceSync();
};
$('renameScenarioBtn').onclick=()=>{
  if(curScenario().locked) return alert('Unlock this scenario to rename.');
  const b=curBike(); const newName=prompt('Rename scenario:', b.currentScenario); if(!newName||newName===b.currentScenario) return;
  if(b.scenarios[newName]) return alert('Name already exists.');
  b.scenarios[newName]=b.scenarios[b.currentScenario]; delete b.scenarios[b.currentScenario];
  b.currentScenario=newName; saveLocal(); renderAll(); debounceSync();
};
$('deleteScenarioBtn').onclick=()=>{
  if(curScenario().locked) return alert('Unlock this scenario to delete.');
  const b=curBike(); if(!confirm(`Delete "${b.currentScenario}"? This cannot be undone.`)) return;
  const names=Object.keys(b.scenarios).filter(n=>n!==b.currentScenario);
  delete b.scenarios[b.currentScenario];
  b.currentScenario=names[0]||'New Setup';
  if(!b.scenarios[b.currentScenario]){ b.scenarios[b.currentScenario]=JSON.parse(JSON.stringify(PRESETS.Standard)); b.scenarios[b.currentScenario].notes=''; b.scenarios[b.currentScenario].ratings={}; b.scenarios[b.currentScenario].locked=false; }
  saveLocal(); renderAll(); debounceSync();
};
function applyPreset(name){ const p=PRESETS[name]; if(!p) return; const s=curScenario(); s.front={...p.front}; s.rear={...p.rear}; saveLocal(); renderValues(); debounceSync(); }
function savePresetAs(name){
  const b=curBike(); const newName=prompt(`Save "${name}" as:`, name+' Copy'); if(!newName) return;
  if(b.scenarios[newName]) return alert('That name already exists.');
  b.scenarios[newName]=JSON.parse(JSON.stringify(PRESETS[name]));
  b.scenarios[newName].notes='(from preset)'; b.scenarios[newName].ratings={}; b.scenarios[newName].locked=false;
  b.currentScenario=newName; saveLocal(); renderAll(); debounceSync();
}

/* ========= BIKES ========= */
$('addBikeBtn').onclick=()=>openAddBikeDialog();
$('cancelAddBike').onclick=()=>$('addBikeDlg').close();
$('bikePhoto').addEventListener('change',async(e)=>{
  const f=e.target.files&&e.target.files[0]; if(!f) return;
  const url=await fileToDataUrl(f);
  $('photoPreview').innerHTML=`<img src="${url}" alt="photo">`;
  $('photoPreview').dataset.url=url;
});
$('confirmAddBike').onclick=()=>{
  const meta={year:$('bikeYear').value.trim(),make:$('bikeMake').value.trim(),model:$('bikeModel').value.trim(),rego:$('bikeRego').value.trim(),photo:$('photoPreview').dataset.url||''};
  const id=$('addBikeDlg').dataset.editing||uid();
  if($('addBikeDlg').dataset.editing){ data.bikes[id].meta=meta; }
  else{ data.bikes[id]={meta,currentScenario:'High Speed Naked',scenarios:defaultScenarios(),service:[]}; data.currentBikeId=id; }
  saveLocal(); $('addBikeDlg').close(); renderAll(); debounceSync();
};
function openAddBikeDialog(existing=null,id=null){
  $('bikeYear').value=existing?.meta.year||''; $('bikeMake').value=existing?.meta.make||''; $('bikeModel').value=existing?.meta.model||''; $('bikeRego').value=existing?.meta.rego||'';
  $('photoPreview').innerHTML=existing?.meta.photo?`<img src="${existing.meta.photo}">`:'Drop or pick an image';
  $('photoPreview').dataset.url=existing?.meta.photo||'';
  if(id){ $('addBikeDlg').dataset.editing=id; } else { delete $('addBikeDlg').dataset.editing; }
  $('addBikeDlg').showModal();
}
function fileToDataUrl(file){ return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);}); }

/* ========= SETTINGS ========= */
$('openSettings').onclick=()=>{ $('dbxToken').value=localStorage.getItem(TOKEN_KEY)||''; $('dbxPath').value=localStorage.getItem(PATH_KEY)||DEFAULT_DBX_PATH; $('settingsDlg').showModal(); };
$('closeSettings').onclick=()=>$('settingsDlg').close();
$('saveSettings').onclick=()=>{ localStorage.setItem(TOKEN_KEY,($('dbxToken').value||'').trim()); localStorage.setItem(PATH_KEY,($('dbxPath').value||'').trim()||DEFAULT_DBX_PATH); dbx=null; $('settingsDlg').close(); loadFromDropboxFirst().then(()=>renderAll()); };
$('signinBtn').onclick=()=>$('openSettings').click();

/* ========= START ========= */
(function init(){
  const local=loadLocal(); if(local) data=local; bootstrapDefault(); renderAll();
  loadFromDropboxFirst().then(()=>{ bootstrapDefault(); renderAll(); });
})();
</script>
</body>
</html>
